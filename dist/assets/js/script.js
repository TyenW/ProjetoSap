let memoria=new Map,PC=0,ACC=0,passos=[],saida=[],running=!1,animationSpeed=1500,assemblyAnterior=[],asmDebounce=null,editMode="ram",asmTouched=!1;const hexParaAssembly={0:"LDA",1:"ADD",2:"SUB",3:"INC",4:"DEC",5:"MUL",6:"JMP",E:"OUT",F:"HLT"};function converterHexParaAssembly(e){if(!e||"00"===e||e.length<2)return"---";const t=e[0].toUpperCase(),a=e[1].toUpperCase(),n=hexParaAssembly[t];return n?["LDA","ADD","SUB","MUL","JMP"].includes(n)?a&&"0"!==a?`${n} A${a}`:`${n} A0`:n:"???"}function atualizarAssemblyDaRAM(){const e=document.getElementById("assemblyCode");if(!e)return;e.innerHTML="";const t=[];let a=!1;for(let n=0;n<16;n++){const o=document.getElementById("order"+(n+1)),s=o?o.value.trim().toUpperCase():"";if(s&&"00"!==s){const t=converterHexParaAssembly(s);if("---"!==t){a=!0;const o=document.createElement("div");o.className="assembly-line",o.setAttribute("data-linha",n);const s=n.toString().padStart(2,"0");o.innerHTML=`${s}: <span class="assembly-instruction">${t}</span>`,assemblyAnterior[n]!==t&&assemblyAnterior.length>0&&(o.classList.add("changed"),setTimeout(()=>o.classList.remove("changed"),600)),e.appendChild(o)}}t.push(s?converterHexParaAssembly(s):"---")}if(!a){const t=document.createElement("div");t.className="assembly-empty-message",t.innerHTML='\n            <div>Digite c√≥digos hexadecimais na RAM</div>\n            <div>para visualizar o Assembly em tempo real!</div>\n            <div style="font-size: 0.8em; margin-top: 8px; opacity: 0.8;">üí° Ex: 0A, 1F, E0, F0...</div>\n        ',e.appendChild(t)}return assemblyAnterior=[...t],t}function aplicarModoEdicaoUI(){const e="asm"===editMode,t=document.getElementById("codigoMaquina"),a=document.getElementById("converterMaquina"),n=Array.from(document.querySelectorAll(".ran")),o=document.querySelector(".memoryran"),s=document.getElementById("displayTitle");n.forEach(t=>t.disabled=e),t&&(t.disabled=!e),a&&(a.disabled=!e),e&&t&&t.focus(),o&&(o.classList.toggle("is-asm",e),o.classList.toggle("is-ram",!e)),s&&(s.textContent=e?"Mem√≥ria RAM em Tempo Real":"Assembly em Tempo Real")}function popularTextareaComAssemblyAtual(){const e=document.getElementById("codigoMaquina");if(!e)return;const t=[];for(let e=0;e<16;e++){const a=converterHexParaAssembly((document.getElementById("order"+(e+1))?.value||"").trim().toUpperCase());t.push("---"===a?"":a)}e.value=t.join("\n")}function isRamVazia(){for(let e=0;e<16;e++){const t=(document.getElementById("order"+(e+1))?.value||"").trim().toUpperCase();if(t&&"00"!==t)return!1}return!0}function montarAssemblyParaRAM(){if("asm"!==editMode)return;const e=document.getElementById("codigoMaquina"),t=document.getElementById("asmErrors");if(!e)return;let a=e.value.replace(/[,;]+/g,"\n");a=a.replace(/\u00A0/g," ");const n=a.split(/\r?\n/),o=[];for(const e of n)o.push(e.trim());const s={LDA:{code:"0",arg:"nibble"},ADD:{code:"1",arg:"nibble"},SUB:{code:"2",arg:"nibble"},INC:{code:"3",arg:"none"},DEC:{code:"4",arg:"none"},MUL:{code:"5",arg:"nibble"},JMP:{code:"6",arg:"nibble"},OUT:{code:"E",arg:"none"},HLT:{code:"F",arg:"none"}},r=[],i=new Array(16).fill("00"),l=new Array(16).fill(!1),c=e=>{if(!e)return null;let t=e.trim().toUpperCase().replace(/^0X/,""),a=null;return/^\d+$/.test(t)?a=parseInt(t,10):/^[0-9A-F]{1,2}$/.test(t)&&(a=parseInt(t,16)),null===a||isNaN(a)||a<0||a>15?null:a},m=e=>{if(!e)return null;let t=e.trim().toUpperCase().replace(/^0X/,"");if(/^\d+$/.test(t)){const e=parseInt(t,10);return isNaN(e)||e<0||e>255?null:e.toString(16).toUpperCase().padStart(2,"0")}return/^[0-9A-F]{1,2}$/.test(t)?t.padStart(2,"0"):null},d=[];o.forEach((e,t)=>{let a=e.replace(/(#|\/\/).*$/,"").trim();if(!a)return;const n=a.split(/\s+/),o=n[0]&&/^(?:0x)?[0-9A-Fa-f]{1,2}$|^\d{1,2}$/.test(n[0]),s=n.length>1&&n[1];if(o&&s){const e=c(n[0]),a=m(n[1]);return void(null===e?r.push(`Linha ${t+1}: Endere√ßo inv√°lido (0‚Äì15).`):a?(i[e]=a,l[e]=!0):r.push(`Linha ${t+1}: Valor inv√°lido (00‚ÄìFF ou 0‚Äì255).`))}const u=a.match(/^(.+?)\s*[,=:]\s*(.+)$/);if(u){const e=c(u[1]),a=m(u[2]);return void(null===e?r.push(`Linha ${t+1}: Endere√ßo inv√°lido (0‚Äì15).`):a?(i[e]=a,l[e]=!0):r.push(`Linha ${t+1}: Valor inv√°lido (00‚ÄìFF ou 0‚Äì255).`))}d.push({text:a,idx:t+1})});let u=0;const p=()=>{for(;u<16&&l[u];)u++;return u<16?u:-1};d.forEach(({text:e,idx:t})=>{const a=e.toUpperCase().match(/^(\w+)(?:\s+(.+))?$/);if(!a)return void r.push(`Linha ${t}: Sintaxe inv√°lida.`);const n=a[1];if(/^[0-9A-F]{2}$/i.test(n)&&(!a[2]||!a[2].trim())){const e=p();return-1===e?void r.push("Sem espa√ßo na mem√≥ria para instru√ß√µes adicionais (limite 16)."):(i[e]=n.toUpperCase(),void(l[e]=!0))}const o=s[n];if(!o)return void r.push(`Linha ${t}: Mnem√¥nico desconhecido: ${n}.`);let c="0";if("nibble"===o.arg){const e=(e=>{if(!e)return null;let t=e.trim().toUpperCase();if(t=t.replace(/^0X/,""),/^\d+$/.test(t)){const e=parseInt(t,10);return isNaN(e)||e<0||e>15?null:e.toString(16).toUpperCase()}if(/^[0-9A-F]{1,2}$/.test(t)){const e=parseInt(t,16);return e<0||e>15?null:e.toString(16).toUpperCase()}return null})((a[2]||"").trim());if(null===e)return void r.push(`Linha ${t}: Operando inv√°lido (0‚ÄìF ou 0‚Äì15).`);c=e}else a[2]&&a[2].trim()&&r.push(`Linha ${t}: ${n} n√£o usa operando. Valor ignorado.`);const m=p();-1!==m?(i[m]=`${o.code}${c}`,l[m]=!0):r.push("Sem espa√ßo na mem√≥ria para instru√ß√µes adicionais (limite 16).")});for(let e=0;e<16;e++){const t=document.getElementById("order"+(e+1));t&&(t.value=i[e])}atualizarRamPreview(),t&&(r.length?(t.innerHTML=r.map(e=>`‚Ä¢ ${e}`).join("<br>"),t.classList.add("visible"),t.style.display="block"):(t.textContent="Montagem conclu√≠da. RAM atualizada.",t.classList.add("visible"),t.style.display="block",t.style.color="#9effa3",t.style.background="rgba(0,255,100,0.08)",t.style.borderColor="rgba(0,255,100,0.25)",setTimeout(()=>{t.style.removeProperty("color"),t.style.removeProperty("background"),t.style.removeProperty("border-color")},2e3))),atualizarAssemblyDaRAM()}function atualizarRamPreview(){for(let e=0;e<16;e++){const t=(document.getElementById("order"+(e+1))?.value||"--").toUpperCase(),a=document.getElementById("preview"+(e+1));a&&(a.textContent=t&&t.length?t:"--")}}function resetAnimations(){document.querySelectorAll(".sap1-block").forEach(e=>{e.classList.remove("active","operation-fetch","operation-execute","operation-store")}),document.querySelectorAll(".arrow-img").forEach(e=>{e.classList.remove("active")}),document.getElementById("barramento").classList.remove("active")}function animateDataTransfer(e,t){const a=e.getBoundingClientRect(),n=t.getBoundingClientRect(),o=document.createElement("div");o.className="data-transfer",o.style.left=a.left+a.width/2+"px",o.style.top=a.top+a.height/2+"px",o.style.position="fixed",document.body.appendChild(o);const s=n.left+n.width/2-(a.left+a.width/2),r=n.top+n.height/2-(a.top+a.height/2);o.style.transform=`translate(${s}px, ${r}px)`,setTimeout(()=>{o.parentNode&&o.parentNode.removeChild(o)},1e3)}function animateInstructionFetch(){resetAnimations(),setTimeout(()=>{document.getElementById("pc").classList.add("active","operation-fetch"),document.querySelector("#pc .arrow-img").classList.add("active")},100),setTimeout(()=>{document.getElementById("barramento").classList.add("active"),animateDataTransfer(document.getElementById("pc"),document.getElementById("ram"))},300),setTimeout(()=>{document.getElementById("ram").classList.add("active","operation-fetch"),document.querySelector("#ram .arrow-img").classList.add("active");try{highlightRamPreviewCell(PC)}catch(e){}},600),setTimeout(()=>{document.getElementById("ri").classList.add("active","operation-fetch"),document.querySelector("#ri .arrow-img").classList.add("active"),animateDataTransfer(document.getElementById("ram"),document.getElementById("ri"))},900),setTimeout(()=>{document.getElementById("controlador").classList.add("active","operation-fetch"),document.querySelector("#controlador .arrow-img").classList.add("active")},1200)}function setTState(e){const t=document.getElementById("tstate-text"),a=document.querySelector(".tstate-steps");if(!t||!a)return;const n="number"==typeof e&&e>=1&&e<=6?e:null;t.textContent=n?`T${n}`:"‚Äî",n&&a.setAttribute("aria-valuenow",String(n)),a.querySelectorAll(".tstep").forEach(e=>{const t=parseInt(e.getAttribute("data-t"),10);n&&t<=n?e.classList.add("active"):e.classList.remove("active")})}function resetTState(){setTState(null)}function highlightRamPreviewCell(e,t=700){if(null==e||isNaN(e))return;const a=Math.max(0,Math.min(15,parseInt(e,10))),n=document.getElementById("preview"+(a+1));n&&(n.classList.add("ram-active"),setTimeout(()=>n.classList.remove("ram-active"),t))}function animateInstructionExecute(e,t=!1,a=null){setTimeout(()=>{document.querySelectorAll(".operation-fetch").forEach(e=>{e.classList.remove("operation-fetch")})},200),t&&null!==a?(setTimeout(()=>{document.getElementById("ram").classList.add("active","operation-execute"),document.querySelector("#ram .arrow-img").classList.add("active");try{highlightRamPreviewCell(a)}catch(e){}},400),setTimeout(()=>{"LDA"===e?(document.getElementById("acc").classList.add("active","operation-execute"),animateDataTransfer(document.getElementById("ram"),document.getElementById("acc"))):(document.getElementById("regb").classList.add("active","operation-execute"),animateDataTransfer(document.getElementById("ram"),document.getElementById("regb")))},700),"LDA"!==e&&(setTimeout(()=>{document.getElementById("alu").classList.add("active","operation-execute"),document.querySelector("#alu .arrow-img").classList.add("active"),animateDataTransfer(document.getElementById("regb"),document.getElementById("alu"))},1e3),setTimeout(()=>{document.getElementById("acc").classList.add("active","operation-execute"),animateDataTransfer(document.getElementById("alu"),document.getElementById("acc"))},1300))):setTimeout(()=>{document.getElementById("acc").classList.add("active","operation-execute"),document.getElementById("alu").classList.add("active","operation-execute"),document.querySelector("#alu .arrow-img").classList.add("active")},400)}function animateOutput(){setTimeout(()=>{document.getElementById("saida").classList.add("active","operation-store"),document.querySelector("#saida .arrow-img").classList.add("active"),animateDataTransfer(document.getElementById("acc"),document.getElementById("saida"))},200),setTimeout(()=>{document.getElementById("visual").classList.add("active","operation-store"),animateDataTransfer(document.getElementById("saida"),document.getElementById("visual"))},600)}function passoAtras(){if(passos.length>1){passos.pop(),resetAnimations(),inicializar();for(let e=1;e<passos.length;e++)executarPassoInterno();atualizarStatus(),mostrarMensagemEstiloMario("Voltou um passo.")}else mostrarMensagemEstiloMario("N√£o √© poss√≠vel voltar mais.")}function resetar(){PC=0,ACC=0,saida=[],running=!1,memoria.clear(),document.getElementById("pc-value").textContent="0",document.getElementById("acc-value").textContent="0",document.getElementById("mar-value").textContent="--",document.getElementById("ram-value").textContent="--",document.getElementById("ri-value").textContent="--",document.getElementById("controller-value").textContent="IDLE",document.getElementById("alu-value").textContent="--",document.getElementById("regb-value").textContent="0",document.getElementById("output-value").textContent="0",document.getElementById("display-value").textContent="00000000";for(let e=1;e<=16;e++){const t=document.getElementById("order"+e);t&&(t.value="")}const e=document.getElementById("assemblyCode");e&&(e.innerHTML='<div class="assembly-line">Nenhum c√≥digo inserido</div>'),resetAnimations(),removerDestaqueExecucao(),atualizarStatus(),escreverNaLabel(""),mostrarMensagemEstiloMario("Sistema resetado completamente!")}function importarCSVParaMemoria(e){if("string"!=typeof e)throw new Error("Conte√∫do inv√°lido");const t=e.split(/\r?\n/).map(e=>e.trim()).filter(e=>e.length>0&&!/^\s*[#;]/.test(e));if(t.length<16)throw new Error("Arquivo possui menos de 16 linhas v√°lidas");for(let e=0;e<16;e++){let a=(t[e]||"").toUpperCase().replace(/[^0-9A-F]/g,"");if(0===a.length&&(a="00"),a.length>2&&(a=a.slice(0,2)),!/^[0-9A-F]{2}$/.test(a))throw new Error(`Valor inv√°lido na linha ${e+1}: ${t[e]}`);const n=document.getElementById("order"+(e+1));n&&(n.value=a)}inicializar(),atualizarStatus(),mostrarMensagemEstiloMario("Mem√≥ria carregada do arquivo!")}function mostrarMensagemEstiloMario(e){const t=document.getElementById("console-log");t.textContent=e,t.style.display="block",setTimeout(()=>{t.style.display="none"},5e3)}function inicializar(){memoria=new Map;for(let e=1;e<=16;e++){const t=e-1;let a=document.getElementById("order"+e).value.trim().toUpperCase();memoria.set(t,a.padStart(2,"0"))}PC=0,ACC=0,passos=[],saida=[],running=!0,document.getElementById("pc-value").textContent="0",document.getElementById("acc-value").textContent="0",document.getElementById("mar-value").textContent="--",document.getElementById("ram-value").textContent="--",document.getElementById("ri-value").textContent="--",document.getElementById("controller-value").textContent="READY",document.getElementById("alu-value").textContent="--",document.getElementById("regb-value").textContent="0",document.getElementById("output-value").textContent="0",document.getElementById("display-value").textContent="00000000",passos.push("In√≠cio: PC=0, ACC=0"),resetAnimations()}function atualizarValorBloco(e,t){const a=document.getElementById(e);a&&(a.textContent=t,a.style.transform="scale(1.1)",a.style.boxShadow="0 0 20px rgba(0, 255, 255, 0.8)",setTimeout(()=>{a.style.transform="scale(1)",a.style.boxShadow=""},300))}function mostrarOperacaoALU(e,t,a,n){const o=document.getElementById("alu-value");o&&(o.textContent=`${e}`,setTimeout(()=>{o.textContent=n},500))}function atualizarStatus(e=""){const t=document.getElementById("pc-value"),a=document.getElementById("acc-value"),n=document.getElementById("ri-value"),o=document.getElementById("output-value"),s=document.getElementById("display-value");if(t&&(t.textContent=PC),a&&(a.textContent=ACC),n&&(n.textContent=e||memoria.get(PC)||"--"),o&&(o.textContent=saida.length>0?saida[saida.length-1]:"0"),s){const e=saida.length>0?parseInt(saida[saida.length-1]):0;s.textContent=e.toString(2).padStart(8,"0")}destacarLinhaAtual(PC)}function adicionarEventosRAM(){for(let e=1;e<=16;e++){const t=document.getElementById("order"+e);t&&t.addEventListener("input",function(){atualizarAssemblyDaRAM()})}}function atualizarRamPreview(){for(let e=0;e<16;e++){const t=(document.getElementById("order"+(e+1))?.value||"--").toUpperCase(),a=document.getElementById("preview"+(e+1));a&&(a.textContent=t&&t.length?t:"--")}}const converterMaquinaBtn=document.getElementById("converterMaquina");function decode(e){if(!e||e.length<2)return{op:"???",arg:0};const t=e[0],a=parseInt(e[1],16);return{op:{0:"LDA",1:"ADD",2:"SUB",3:"INC",4:"DEC",5:"MUL",6:"JMP",E:"OUT",F:"HLT"}[t]||"???",arg:isNaN(a)?0:a}}function destacarLinhaAtual(e){document.querySelectorAll(".assembly-line").forEach(e=>{e.classList.remove("executing")});const t=document.querySelector(`[data-linha="${e}"]`);t&&(t.classList.add("executing"),console.log(`Destacando linha ${e} para execu√ß√£o`))}function removerDestaqueExecucao(){document.querySelectorAll(".assembly-line").forEach(e=>{e.classList.remove("executing")})}function executarPasso(){if(!running||PC>=16)return void mostrarMensagemEstiloMario(passos.join("\n")+(saida.length?"\nSa√≠da: "+saida.join(", "):""));const e=memoria.get(PC)||"0000",{op:t,arg:a}=decode(e),n=Math.max(120,Math.floor(animationSpeed/6));animateInstructionFetch(),resetTState(),setTState(1),setTimeout(()=>setTState(2),n),setTimeout(()=>setTState(3),2*n),setTimeout(()=>{switch(passos.push(`PC=${PC} | Instr: ${e} | ACC=${ACC}`),t){case"LDA":animateInstructionExecute("LDA",!0,a);const t=parseInt(memoria.get(a)||"0000",16);atualizarValorBloco("ram-value",memoria.get(a)||"--"),atualizarValorBloco("mar-value",a),ACC=t,atualizarValorBloco("acc-value",ACC),passos.push(`LDA ${a}: ACC <- MEM[${a}] = ${memoria.get(a)} (${ACC})`),PC++;break;case"ADD":animateInstructionExecute("ADD",!0,a);const n=parseInt(memoria.get(a)||"0000",16);atualizarValorBloco("regb-value",n),atualizarValorBloco("mar-value",a),mostrarOperacaoALU("ADD",ACC,n,ACC+n),ACC+=n,atualizarValorBloco("acc-value",ACC),passos.push(`ADD ${a}: ACC += MEM[${a}] = ${memoria.get(a)} (ACC=${ACC})`),PC++;break;case"SUB":animateInstructionExecute("SUB",!0,a);const o=parseInt(memoria.get(a)||"0000",16);atualizarValorBloco("regb-value",o),atualizarValorBloco("mar-value",a),mostrarOperacaoALU("SUB",ACC,o,ACC-o),ACC-=o,atualizarValorBloco("acc-value",ACC),passos.push(`SUB ${a}: ACC -= MEM[${a}] = ${memoria.get(a)} (ACC=${ACC})`),PC++;break;case"INC":animateInstructionExecute("INC",!1),mostrarOperacaoALU("INC",ACC,1,ACC+1),ACC++,atualizarValorBloco("acc-value",ACC),passos.push(`INC: ACC++ (ACC=${ACC})`),PC++;break;case"DEC":animateInstructionExecute("DEC",!1),mostrarOperacaoALU("DEC",ACC,1,ACC-1),ACC--,atualizarValorBloco("acc-value",ACC),passos.push(`DEC: ACC-- (ACC=${ACC})`),PC++;break;case"MUL":animateInstructionExecute("MUL",!0,a);const s=parseInt(memoria.get(a)||"0000",16);atualizarValorBloco("regb-value",s),atualizarValorBloco("mar-value",a),mostrarOperacaoALU("MUL",ACC,s,ACC*s),ACC*=s,atualizarValorBloco("acc-value",ACC),passos.push(`MUL ${a}: ACC *= MEM[${a}] = ${memoria.get(a)} (ACC=${ACC})`),PC++;break;case"JMP":passos.push(`JMP para ${a}`),atualizarValorBloco("controller-value",`JMP‚Üí${a}`),PC=a,atualizarValorBloco("pc-value",PC);break;case"OUT":animateOutput(),passos.push(`OUT: ${ACC}`),saida.push(ACC),atualizarValorBloco("output-value",ACC),atualizarValorBloco("display-value",ACC.toString(2).padStart(8,"0")),PC++;break;case"HLT":passos.push("HLT: Parada"),atualizarValorBloco("controller-value","HALT"),running=!1;break;default:passos.push(`Instru√ß√£o desconhecida: ${e}`),running=!1}setTState(4),setTimeout(()=>setTState(5),n),setTimeout(()=>setTState(6),2*n),mostrarMensagemEstiloMario(passos[passos.length-1]),setTimeout(()=>{atualizarStatus(e)},500)},animationSpeed)}function executarTudo(){running&&0!==passos.length||inicializar(),resetAnimations(),mostrarMensagemEstiloMario("Executando todas as instru√ß√µes..."),function e(){running&&PC<16?(executarPasso(),setTimeout(e,animationSpeed+500)):setTimeout(()=>{mostrarMensagemEstiloMario(passos.join("\n")+(saida.length?"\nSa√≠da: "+saida.join(", "):"")),resetAnimations()},1e3)}()}function executarPassoInterno(){if(!running||PC>=16)return;const e=memoria.get(PC)||"0000",{op:t,arg:a}=decode(e);switch(passos.push(`PC=${PC} | Instr: ${e} | ACC=${ACC}`),t){case"LDA":ACC=parseInt(memoria.get(a)||"0000",16),passos.push(`LDA ${a}: ACC <- MEM[${a}] = ${memoria.get(a)} (${ACC})`),PC++;break;case"ADD":ACC+=parseInt(memoria.get(a)||"0000",16),passos.push(`ADD ${a}: ACC += MEM[${a}] = ${memoria.get(a)} (ACC=${ACC})`),PC++;break;case"SUB":ACC-=parseInt(memoria.get(a)||"0000",16),passos.push(`SUB ${a}: ACC -= MEM[${a}] = ${memoria.get(a)} (ACC=${ACC})`),PC++;break;case"INC":ACC++,passos.push(`INC: ACC++ (ACC=${ACC})`),PC++;break;case"DEC":ACC--,passos.push(`DEC: ACC-- (ACC=${ACC})`),PC++;break;case"MUL":ACC*=parseInt(memoria.get(a)||"0000",16),passos.push(`MUL ${a}: ACC *= MEM[${a}] = ${memoria.get(a)} (ACC=${ACC})`),PC++;break;case"JMP":passos.push(`JMP para ${a}`),PC=a;break;case"OUT":passos.push(`OUT: ${ACC}`),saida.push(ACC),PC++;break;case"HLT":passos.push("HLT: Parada"),running=!1;break;default:passos.push(`Instru√ß√£o desconhecida: ${e}`),running=!1}}function escreverNaLabel(e){mostrarMensagemEstiloMario(e)}converterMaquinaBtn&&converterMaquinaBtn.addEventListener("click",function(){editMode="asm",document.getElementById("modeAsm")?.setAttribute("checked","checked"),document.getElementById("modeRam")?.removeAttribute("checked"),aplicarModoEdicaoUI(),montarAssemblyParaRAM(),inicializar(),atualizarStatus(),mostrarMensagemEstiloMario("Assembly montado e aplicado na RAM!")}),document.addEventListener("DOMContentLoaded",function(){atualizarAssemblyDaRAM(),aplicarModoEdicaoUI(),adicionarEventosRAM(),atualizarRamPreview(),document.getElementById("passo").addEventListener("click",function(){"asm"===editMode&&montarAssemblyParaRAM(),running&&0!==passos.length||inicializar(),executarPasso()}),document.getElementById("emular").addEventListener("click",function(){"asm"===editMode&&montarAssemblyParaRAM(),inicializar(),executarTudo()}),document.getElementById("passo-atras").addEventListener("click",passoAtras),document.getElementById("resetar").addEventListener("click",resetar),document.getElementById("loadCSV").addEventListener("click",function(){document.getElementById("csvInput").click()}),document.getElementById("speedRange").addEventListener("input",function(){animationSpeed=parseInt(this.value),document.getElementById("speedValue").textContent={500:"R√°pido",750:"R√°pido",1e3:"R√°pido",1250:"Normal",1500:"Normal",1750:"Normal",2e3:"Lento",2250:"Lento",2500:"Muito Lento",2750:"Muito Lento",3e3:"Muito Lento"}[animationSpeed]||"Normal"}),document.getElementById("csvInput").addEventListener("change",function(e){try{const t=e.target.files[0];if(!t)return;if(t.size>262144)return void mostrarMensagemEstiloMario("Arquivo muito grande (>256KB). Use um CSV/TXT com at√© 16 linhas.");const a=new FileReader;a.onerror=()=>mostrarMensagemEstiloMario("Erro ao ler o arquivo. Tente novamente."),a.onload=function(e){try{importarCSVParaMemoria(e.target.result)}catch(e){mostrarMensagemEstiloMario("Formato inv√°lido: 16 linhas com 2 d√≠gitos hex (ex: 0A, 1F).")}},a.readAsText(t)}catch(e){mostrarMensagemEstiloMario("N√£o foi poss√≠vel processar o arquivo selecionado.")}});const e=document.getElementById("codigoMaquina");e&&e.addEventListener("input",function(){"asm"===editMode&&(asmTouched=!0,clearTimeout(asmDebounce),asmDebounce=setTimeout(()=>{montarAssemblyParaRAM()},250))});const t=document.getElementById("aplicarSequencia");t&&t.addEventListener("click",()=>{montarAssemblyParaRAM(),inicializar(),atualizarStatus()});try{const e=window.matchMedia("(pointer: coarse)").matches,t=window.matchMedia("(max-width: 768px)").matches,a=document.querySelector(".sap-help-icon"),n=a?a.querySelector(".sap-tooltip"):null;if(a&&n&&(e||t)){const e=document.createElement("div");e.className="sap-help-overlay",e.setAttribute("role","dialog"),e.setAttribute("aria-modal","true"),e.setAttribute("aria-labelledby","sapHelpTitle"),e.innerHTML=`\n                    <div class="sap-help-card" tabindex="-1">\n                        <button class="sap-help-close" aria-label="Fechar ajuda">‚úñ</button>\n                        <h3 id="sapHelpTitle" style="margin-top:0;">Ajuda SAP-1</h3>\n                        ${n.innerHTML}\n                    </div>`,document.body.appendChild(e);const t=t=>{t.preventDefault(),e.classList.add("visible");const a=e.querySelector(".sap-help-card");a&&a.focus()},o=()=>{e.classList.remove("visible"),a.focus()};a.addEventListener("click",t),e.addEventListener("click",t=>{t.target===e&&o()}),e.querySelector(".sap-help-close").addEventListener("click",o),document.addEventListener("keydown",t=>{e.classList.contains("visible")&&"Escape"===t.key&&o()})}}catch(e){console.warn("Falha ao inicializar modal de ajuda SAP-1:",e)}try{const e=document.getElementById("modeRam"),t=document.getElementById("modeAsm"),a=document.getElementById("asmErrors");if(e&&t){const n=()=>{if(editMode=t.checked?"asm":"ram",aplicarModoEdicaoUI(),"asm"===editMode){if(!asmTouched&&isRamVazia()){const e=document.getElementById("codigoMaquina");e&&(e.value="")}else popularTextareaComAssemblyAtual();montarAssemblyParaRAM(),a&&(a.style.display="none",a.classList.remove("visible")),atualizarRamPreview()}else montarAssemblyParaRAM(),a&&(a.style.display="none",a.classList.remove("visible")),atualizarRamPreview();atualizarAssemblyDaRAM()};e.addEventListener("change",n),t.addEventListener("change",n)}}catch(e){console.warn("Falha ao conectar switch de modo:",e)}});const memoryDiv=document.querySelector(".memoryran"),otherLogicDiv=document.querySelector(".other-logic"),toggleBtn=document.getElementById("toggleLogic");toggleBtn&&memoryDiv&&otherLogicDiv&&toggleBtn.addEventListener("click",()=>{"none"===memoryDiv.style.display?(memoryDiv.style.display="",otherLogicDiv.style.display="none"):(memoryDiv.style.display="none",otherLogicDiv.style.display="")}),document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("bg-music"),t=document.getElementById("muteToggle"),a=()=>{t.setAttribute("aria-pressed",String(!e.muted)),t.setAttribute("aria-label",e.muted?"Ativar som":"Desativar som")};a(),t.addEventListener("click",()=>{e.muted=!e.muted,t.textContent=e.muted?"üîá":"üîä",a()})});